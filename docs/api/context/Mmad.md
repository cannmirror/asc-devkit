# Mmad<a name="ZH-CN_TOPIC_0000001449620518"></a>

## 产品支持情况<a name="section1550532418810"></a>

<a name="table38301303189"></a>
<table><thead align="left"><tr id="row20831180131817"><th class="cellrowborder" valign="top" width="52.800000000000004%" id="mcps1.1.4.1.1"><p id="p1883113061818"><a name="p1883113061818"></a><a name="p1883113061818"></a><span id="ph20833205312295"><a name="ph20833205312295"></a><a name="ph20833205312295"></a>产品</span></p>
</th>
<th class="cellrowborder" align="center" valign="top" width="24.51%" id="mcps1.1.4.1.2"><p id="p78368183115"><a name="p78368183115"></a><a name="p78368183115"></a>是否支持（</p>
<p id="p18297174143119"><a name="p18297174143119"></a><a name="p18297174143119"></a>不传入bias的原型</p>
<p id="p783113012187"><a name="p783113012187"></a><a name="p783113012187"></a>）</p>
</th>
<th class="cellrowborder" align="center" valign="top" width="22.689999999999998%" id="mcps1.1.4.1.3"><p id="p13733161315318"><a name="p13733161315318"></a><a name="p13733161315318"></a>是否支持（</p>
<p id="p1273341316313"><a name="p1273341316313"></a><a name="p1273341316313"></a>传入bias的原型</p>
<p id="p1073311310312"><a name="p1073311310312"></a><a name="p1073311310312"></a>）</p>
</th>
</tr>
</thead>
<tbody><tr id="row220181016240"><td class="cellrowborder" valign="top" width="52.800000000000004%" headers="mcps1.1.4.1.1 "><p id="p48327011813"><a name="p48327011813"></a><a name="p48327011813"></a><span id="ph583230201815"><a name="ph583230201815"></a><a name="ph583230201815"></a><term id="zh-cn_topic_0000001312391781_term1253731311225"><a name="zh-cn_topic_0000001312391781_term1253731311225"></a><a name="zh-cn_topic_0000001312391781_term1253731311225"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term131434243115"><a name="zh-cn_topic_0000001312391781_term131434243115"></a><a name="zh-cn_topic_0000001312391781_term131434243115"></a>Atlas A3 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="24.51%" headers="mcps1.1.4.1.2 "><p id="p7948163910184"><a name="p7948163910184"></a><a name="p7948163910184"></a>√</p>
</td>
<td class="cellrowborder" align="center" valign="top" width="22.689999999999998%" headers="mcps1.1.4.1.3 "><p id="p33014304302"><a name="p33014304302"></a><a name="p33014304302"></a>√</p>
</td>
</tr>
<tr id="row173226882415"><td class="cellrowborder" valign="top" width="52.800000000000004%" headers="mcps1.1.4.1.1 "><p id="p14832120181815"><a name="p14832120181815"></a><a name="p14832120181815"></a><span id="ph1483216010188"><a name="ph1483216010188"></a><a name="ph1483216010188"></a><term id="zh-cn_topic_0000001312391781_term11962195213215"><a name="zh-cn_topic_0000001312391781_term11962195213215"></a><a name="zh-cn_topic_0000001312391781_term11962195213215"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term184716139811"><a name="zh-cn_topic_0000001312391781_term184716139811"></a><a name="zh-cn_topic_0000001312391781_term184716139811"></a>Atlas A2 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="24.51%" headers="mcps1.1.4.1.2 "><p id="p19948143911820"><a name="p19948143911820"></a><a name="p19948143911820"></a>√</p>
</td>
<td class="cellrowborder" align="center" valign="top" width="22.689999999999998%" headers="mcps1.1.4.1.3 "><p id="p1830183013305"><a name="p1830183013305"></a><a name="p1830183013305"></a>√</p>
</td>
</tr>
<tr id="row1511953192517"><td class="cellrowborder" valign="top" width="52.800000000000004%" headers="mcps1.1.4.1.1 "><p id="p7743750164"><a name="p7743750164"></a><a name="p7743750164"></a><span id="ph171873262101"><a name="ph171873262101"></a><a name="ph171873262101"></a>Kirin X90</span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="24.51%" headers="mcps1.1.4.1.2 "><p id="p167558406157"><a name="p167558406157"></a><a name="p167558406157"></a>√</p>
</td>
<td class="cellrowborder" align="center" valign="top" width="22.689999999999998%" headers="mcps1.1.4.1.3 "><p id="p2120123122510"><a name="p2120123122510"></a><a name="p2120123122510"></a>√</p>
</td>
</tr>
<tr id="row155833520251"><td class="cellrowborder" valign="top" width="52.800000000000004%" headers="mcps1.1.4.1.1 "><p id="p175815356258"><a name="p175815356258"></a><a name="p175815356258"></a><span id="ph144811767473"><a name="ph144811767473"></a><a name="ph144811767473"></a>Kirin 9030</span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="24.51%" headers="mcps1.1.4.1.2 "><p id="p11591635102516"><a name="p11591635102516"></a><a name="p11591635102516"></a>√</p>
</td>
<td class="cellrowborder" align="center" valign="top" width="22.689999999999998%" headers="mcps1.1.4.1.3 "><p id="p155983515257"><a name="p155983515257"></a><a name="p155983515257"></a>x</p>
</td>
</tr>
</tbody>
</table>

## 功能说明<a name="section618mcpsimp"></a>

完成矩阵乘加（C += A \* B）操作。矩阵ABC分别为A2/B2/CO1中的数据。

-   ABC矩阵的数据排布格式分别为ZZ，ZN，NZ。

    下图中每个小方格代表一个分形矩阵，Z字形的黑色线条代表数据的排列顺序，起始点是左上角，终点是右下角。

    矩阵A：每个分形矩阵内部是行主序，分形矩阵之间是行主序。简称小Z大Z格式。分形shape为16 x \(32B/sizeof\(AType\)\)，大小为512Byte。

    矩阵B：每个分形矩阵内部是列主序，分形矩阵之间是行主序。简称小N大Z格式。分形shape为 \(32B/sizeof\(BType\)\) x 16，大小为512Byte。

    矩阵C：每个分形矩阵内部是行主序，分形矩阵之间是列主序。简称小Z大N格式。分形shape为16 x 16，大小为256个元素。

    ![](figures/zh-cn_image_0000002106261090.jpg)

    以下是一个简单的例子，假设分形矩阵的大小是2x2（并不符合真实情况，仅作为示例），矩阵ABC的大小都是4x4。

    <a name="table373155317187"></a>
    <table><tbody><tr id="row1313675316183"><td class="cellrowborder" valign="top" width="25%"><p id="p21361553151811"><a name="p21361553151811"></a><a name="p21361553151811"></a>0</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p13136115311812"><a name="p13136115311812"></a><a name="p13136115311812"></a>1</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p141361053131814"><a name="p141361053131814"></a><a name="p141361053131814"></a>2</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p613619535187"><a name="p613619535187"></a><a name="p613619535187"></a>3</p>
    </td>
    </tr>
    <tr id="row1413614535182"><td class="cellrowborder" valign="top" width="25%"><p id="p513614535188"><a name="p513614535188"></a><a name="p513614535188"></a>4</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p213695351814"><a name="p213695351814"></a><a name="p213695351814"></a>5</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p1913665314187"><a name="p1913665314187"></a><a name="p1913665314187"></a>6</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p2137553191816"><a name="p2137553191816"></a><a name="p2137553191816"></a>7</p>
    </td>
    </tr>
    <tr id="row9137185313187"><td class="cellrowborder" valign="top" width="25%"><p id="p191377536186"><a name="p191377536186"></a><a name="p191377536186"></a>8</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p51371753101810"><a name="p51371753101810"></a><a name="p51371753101810"></a>9</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p11371053151819"><a name="p11371053151819"></a><a name="p11371053151819"></a>10</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p11371853201810"><a name="p11371853201810"></a><a name="p11371853201810"></a>11</p>
    </td>
    </tr>
    <tr id="row91373532182"><td class="cellrowborder" valign="top" width="25%"><p id="p2013725341818"><a name="p2013725341818"></a><a name="p2013725341818"></a>12</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p1213719531185"><a name="p1213719531185"></a><a name="p1213719531185"></a>13</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p8137135341812"><a name="p8137135341812"></a><a name="p8137135341812"></a>14</p>
    </td>
    <td class="cellrowborder" valign="top" width="25%"><p id="p1137105331813"><a name="p1137105331813"></a><a name="p1137105331813"></a>15</p>
    </td>
    </tr>
    </tbody>
    </table>

    矩阵A的排列顺序：0，1，4，5，2，3，6，7，8，9，12，13，10，11，14，15。

    矩阵B的排列顺序：0，4，1，5，2，6，3，7，8，12，9，13，10，14，11，15。

    矩阵C的排列顺序：0，1，4，5，8，9，12，13，2，3，6，7，10，11，14，15。

## 函数原型<a name="section620mcpsimp"></a>

-   不传入bias

    ```
    template <typename T, typename U, typename S>
    __aicore__ inline void Mmad(const LocalTensor<T>& dst, const LocalTensor<U>& fm, const LocalTensor<S>& filter, const MmadParams& mmadParams)
    
    ```

-   传入bias

    ```
    template <typename T, typename U, typename S, typename V>
    __aicore__ inline void Mmad(const LocalTensor<T>& dst, const LocalTensor<U>& fm, const LocalTensor<S>& filter, const LocalTensor<V>& bias, const MmadParams& mmadParams)
    
    ```

## 参数说明<a name="section622mcpsimp"></a>

**表 1**  模板参数说明

<a name="table4835205712588"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001429830437_row118356578583"><th class="cellrowborder" valign="top" width="16.28%" id="mcps1.2.3.1.1"><p id="zh-cn_topic_0000001429830437_p48354572582"><a name="zh-cn_topic_0000001429830437_p48354572582"></a><a name="zh-cn_topic_0000001429830437_p48354572582"></a>参数名</p>
</th>
<th class="cellrowborder" valign="top" width="83.72%" id="mcps1.2.3.1.2"><p id="zh-cn_topic_0000001429830437_p583535795817"><a name="zh-cn_topic_0000001429830437_p583535795817"></a><a name="zh-cn_topic_0000001429830437_p583535795817"></a>描述</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001429830437_row1835857145817"><td class="cellrowborder" valign="top" width="16.28%" headers="mcps1.2.3.1.1 "><p id="p1878815299212"><a name="p1878815299212"></a><a name="p1878815299212"></a>T</p>
</td>
<td class="cellrowborder" valign="top" width="83.72%" headers="mcps1.2.3.1.2 "><p id="zh-cn_topic_0000001429830437_p168351657155818"><a name="zh-cn_topic_0000001429830437_p168351657155818"></a><a name="zh-cn_topic_0000001429830437_p168351657155818"></a>目的操作数的数据类型。</p>
</td>
</tr>
<tr id="row136464572120"><td class="cellrowborder" valign="top" width="16.28%" headers="mcps1.2.3.1.1 "><p id="p93642452214"><a name="p93642452214"></a><a name="p93642452214"></a>U</p>
</td>
<td class="cellrowborder" valign="top" width="83.72%" headers="mcps1.2.3.1.2 "><p id="p1636494511213"><a name="p1636494511213"></a><a name="p1636494511213"></a>左矩阵的数据类型。</p>
</td>
</tr>
<tr id="row412811612220"><td class="cellrowborder" valign="top" width="16.28%" headers="mcps1.2.3.1.1 "><p id="p16128661229"><a name="p16128661229"></a><a name="p16128661229"></a>S</p>
</td>
<td class="cellrowborder" valign="top" width="83.72%" headers="mcps1.2.3.1.2 "><p id="p312816614228"><a name="p312816614228"></a><a name="p312816614228"></a>右矩阵的数据类型。</p>
</td>
</tr>
<tr id="row5725191113227"><td class="cellrowborder" valign="top" width="16.28%" headers="mcps1.2.3.1.1 "><p id="p10725151162211"><a name="p10725151162211"></a><a name="p10725151162211"></a>V</p>
</td>
<td class="cellrowborder" valign="top" width="83.72%" headers="mcps1.2.3.1.2 "><p id="p117251111172216"><a name="p117251111172216"></a><a name="p117251111172216"></a>Bias矩阵的数据类型。</p>
</td>
</tr>
</tbody>
</table>

**表 2**  参数说明

<a name="table8955841508"></a>
<table><thead align="left"><tr id="row15956194105014"><th class="cellrowborder" valign="top" width="13.661366136613662%" id="mcps1.2.4.1.1"><p id="p7956144195014"><a name="p7956144195014"></a><a name="p7956144195014"></a>参数名称</p>
</th>
<th class="cellrowborder" valign="top" width="10.341034103410342%" id="mcps1.2.4.1.2"><p id="p1295624145013"><a name="p1295624145013"></a><a name="p1295624145013"></a>输入/输出</p>
</th>
<th class="cellrowborder" valign="top" width="75.997599759976%" id="mcps1.2.4.1.3"><p id="p16956144145011"><a name="p16956144145011"></a><a name="p16956144145011"></a>含义</p>
</th>
</tr>
</thead>
<tbody><tr id="row5956546509"><td class="cellrowborder" valign="top" width="13.661366136613662%" headers="mcps1.2.4.1.1 "><p id="p19287714181617"><a name="p19287714181617"></a><a name="p19287714181617"></a>dst</p>
</td>
<td class="cellrowborder" valign="top" width="10.341034103410342%" headers="mcps1.2.4.1.2 "><p id="p192871614151615"><a name="p192871614151615"></a><a name="p192871614151615"></a>输出</p>
</td>
<td class="cellrowborder" valign="top" width="75.997599759976%" headers="mcps1.2.4.1.3 "><p id="p16287121461618"><a name="p16287121461618"></a><a name="p16287121461618"></a>目的操作数，结果矩阵，类型为LocalTensor，支持的TPosition为CO1。</p>
<p id="p20650230163918"><a name="p20650230163918"></a><a name="p20650230163918"></a><span id="ph1479701815419"><a name="ph1479701815419"></a><a name="ph1479701815419"></a>LocalTensor的起始地址需要256个元素对齐。</span></p>
</td>
</tr>
<tr id="row4956154125018"><td class="cellrowborder" valign="top" width="13.661366136613662%" headers="mcps1.2.4.1.1 "><p id="p142871414131614"><a name="p142871414131614"></a><a name="p142871414131614"></a>fm</p>
</td>
<td class="cellrowborder" valign="top" width="10.341034103410342%" headers="mcps1.2.4.1.2 "><p id="p628711148165"><a name="p628711148165"></a><a name="p628711148165"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="75.997599759976%" headers="mcps1.2.4.1.3 "><p id="p0287191420164"><a name="p0287191420164"></a><a name="p0287191420164"></a>源操作数，左矩阵a，类型为LocalTensor，支持的TPosition为A2。</p>
<p id="p678295463916"><a name="p678295463916"></a><a name="p678295463916"></a><span id="ph1724515516399"><a name="ph1724515516399"></a><a name="ph1724515516399"></a>LocalTensor的起始地址需要512字节对齐。</span></p>
</td>
</tr>
<tr id="row9486215111718"><td class="cellrowborder" valign="top" width="13.661366136613662%" headers="mcps1.2.4.1.1 "><p id="p1648712150175"><a name="p1648712150175"></a><a name="p1648712150175"></a>filter</p>
</td>
<td class="cellrowborder" valign="top" width="10.341034103410342%" headers="mcps1.2.4.1.2 "><p id="p19487171515178"><a name="p19487171515178"></a><a name="p19487171515178"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="75.997599759976%" headers="mcps1.2.4.1.3 "><p id="p3487131516175"><a name="p3487131516175"></a><a name="p3487131516175"></a>源操作数，右矩阵b，类型为LocalTensor，支持的TPosition为B2。</p>
<p id="p75215694018"><a name="p75215694018"></a><a name="p75215694018"></a><span id="ph11804186104020"><a name="ph11804186104020"></a><a name="ph11804186104020"></a>LocalTensor的起始地址需要512字节对齐。</span></p>
</td>
</tr>
<tr id="row596225716543"><td class="cellrowborder" valign="top" width="13.661366136613662%" headers="mcps1.2.4.1.1 "><p id="p696218575548"><a name="p696218575548"></a><a name="p696218575548"></a>bias</p>
</td>
<td class="cellrowborder" valign="top" width="10.341034103410342%" headers="mcps1.2.4.1.2 "><p id="p896275745413"><a name="p896275745413"></a><a name="p896275745413"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="75.997599759976%" headers="mcps1.2.4.1.3 "><p id="p3962135715414"><a name="p3962135715414"></a><a name="p3962135715414"></a>源操作数，bias矩阵，类型为LocalTensor，支持的TPosition为C2、CO1。</p>
<p id="p9789121314402"><a name="p9789121314402"></a><a name="p9789121314402"></a><span id="ph181430144409"><a name="ph181430144409"></a><a name="ph181430144409"></a>LocalTensor的起始地址需要128字节对齐。</span></p>
</td>
</tr>
<tr id="row1075785651510"><td class="cellrowborder" valign="top" width="13.661366136613662%" headers="mcps1.2.4.1.1 "><p id="p1728791441620"><a name="p1728791441620"></a><a name="p1728791441620"></a>mmadParams</p>
</td>
<td class="cellrowborder" valign="top" width="10.341034103410342%" headers="mcps1.2.4.1.2 "><p id="p11287151451610"><a name="p11287151451610"></a><a name="p11287151451610"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="75.997599759976%" headers="mcps1.2.4.1.3 "><p id="p10391459201718"><a name="p10391459201718"></a><a name="p10391459201718"></a>矩阵乘相关参数，该参数类型的具体定义请参考<span id="ph10562197165916"><a name="ph10562197165916"></a><a name="ph10562197165916"></a>${INSTALL_DIR}</span>/include/ascendc/basic_api/interface/kernel_struct_mm.h，<span id="ph14322531015"><a name="ph14322531015"></a><a name="ph14322531015"></a>${INSTALL_DIR}</span>请替换为CANN软件安装后文件存储路径。</p>
<p id="p1642893817436"><a name="p1642893817436"></a><a name="p1642893817436"></a>MmadParams参数说明请参考<a href="#table15780447181917">表3</a>。</p>
</td>
</tr>
</tbody>
</table>

**表 3**  MmadParams结构体内参数说明

<a name="table15780447181917"></a>
<table><thead align="left"><tr id="row0780947111915"><th class="cellrowborder" valign="top" width="15.310000000000002%" id="mcps1.2.3.1.1"><p id="p1780124771913"><a name="p1780124771913"></a><a name="p1780124771913"></a>参数名称</p>
</th>
<th class="cellrowborder" valign="top" width="84.69%" id="mcps1.2.3.1.2"><p id="p1578014718198"><a name="p1578014718198"></a><a name="p1578014718198"></a>含义</p>
</th>
</tr>
</thead>
<tbody><tr id="row10780647151919"><td class="cellrowborder" valign="top" width="15.310000000000002%" headers="mcps1.2.3.1.1 "><p id="p6340835122118"><a name="p6340835122118"></a><a name="p6340835122118"></a>m</p>
</td>
<td class="cellrowborder" valign="top" width="84.69%" headers="mcps1.2.3.1.2 "><p id="p12340173514212"><a name="p12340173514212"></a><a name="p12340173514212"></a>左矩阵Height，取值范围：m∈[0, 4095] 。默认值为0。</p>
</td>
</tr>
<tr id="row6780947191919"><td class="cellrowborder" valign="top" width="15.310000000000002%" headers="mcps1.2.3.1.1 "><p id="p1934033512213"><a name="p1934033512213"></a><a name="p1934033512213"></a>n</p>
</td>
<td class="cellrowborder" valign="top" width="84.69%" headers="mcps1.2.3.1.2 "><p id="p1634012352218"><a name="p1634012352218"></a><a name="p1634012352218"></a>右矩阵Width，取值范围：n∈[0, 4095] 。默认值为0。</p>
</td>
</tr>
<tr id="row1078074711194"><td class="cellrowborder" valign="top" width="15.310000000000002%" headers="mcps1.2.3.1.1 "><p id="p334033518217"><a name="p334033518217"></a><a name="p334033518217"></a>k</p>
</td>
<td class="cellrowborder" valign="top" width="84.69%" headers="mcps1.2.3.1.2 "><p id="p1734053517219"><a name="p1734053517219"></a><a name="p1734053517219"></a>左矩阵Width、右矩阵Height，取值范围：k∈[0, 4095] 。默认值为0。</p>
</td>
</tr>
<tr id="row6841419175220"><td class="cellrowborder" valign="top" width="15.310000000000002%" headers="mcps1.2.3.1.1 "><p id="p18411019105212"><a name="p18411019105212"></a><a name="p18411019105212"></a>cmatrixInitVal</p>
</td>
<td class="cellrowborder" valign="top" width="84.69%" headers="mcps1.2.3.1.2 "><p id="p265513193113"><a name="p265513193113"></a><a name="p265513193113"></a>配置C矩阵初始值是否为0。默认值true。</p>
<a name="ul146560193120"></a><a name="ul146560193120"></a><ul id="ul146560193120"><li>true：C矩阵初始值为0；</li><li>false：C矩阵初始值通过cmatrixSource参数进行配置。</li></ul>
</td>
</tr>
<tr id="row1444514394710"><td class="cellrowborder" valign="top" width="15.310000000000002%" headers="mcps1.2.3.1.1 "><p id="p1968195019710"><a name="p1968195019710"></a><a name="p1968195019710"></a>cmatrixSource</p>
</td>
<td class="cellrowborder" valign="top" width="84.69%" headers="mcps1.2.3.1.2 "><p id="p46815014712"><a name="p46815014712"></a><a name="p46815014712"></a>配置C矩阵初始值是否来源于C2（存放Bias的硬件缓存区）。默认值为false。</p>
<a name="ul36813507713"></a><a name="ul36813507713"></a><ul id="ul36813507713"><li>false：来源于CO1；</li></ul>
<a name="ul206805011715"></a><a name="ul206805011715"></a><ul id="ul206805011715"><li>true：来源于C2。</li></ul>
<p id="p136815501475"><a name="p136815501475"></a><a name="p136815501475"></a><span id="ph14689501479"><a name="ph14689501479"></a><a name="ph14689501479"></a><term id="zh-cn_topic_0000001312391781_term11962195213215_1"><a name="zh-cn_topic_0000001312391781_term11962195213215_1"></a><a name="zh-cn_topic_0000001312391781_term11962195213215_1"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term184716139811_1"><a name="zh-cn_topic_0000001312391781_term184716139811_1"></a><a name="zh-cn_topic_0000001312391781_term184716139811_1"></a>Atlas A2 推理系列产品</term></span>，支持配置为true/false。</p>
<p id="p91531273575"><a name="p91531273575"></a><a name="p91531273575"></a><span id="ph9153152715719"><a name="ph9153152715719"></a><a name="ph9153152715719"></a><term id="zh-cn_topic_0000001312391781_term1253731311225_1"><a name="zh-cn_topic_0000001312391781_term1253731311225_1"></a><a name="zh-cn_topic_0000001312391781_term1253731311225_1"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term131434243115_1"><a name="zh-cn_topic_0000001312391781_term131434243115_1"></a><a name="zh-cn_topic_0000001312391781_term131434243115_1"></a>Atlas A3 推理系列产品</term></span>，支持配置为true/false。</p>
<p id="p649352174712"><a name="p649352174712"></a><a name="p649352174712"></a><span id="ph649312144719"><a name="ph649312144719"></a><a name="ph649312144719"></a>Kirin X90</span> 仅支持配置为false。</p>
<p id="p27233916477"><a name="p27233916477"></a><a name="p27233916477"></a><span id="ph272193964718"><a name="ph272193964718"></a><a name="ph272193964718"></a>Kirin 9030</span>仅支持配置为false。</p>
<p id="p18124101113283"><a name="p18124101113283"></a><a name="p18124101113283"></a>注意：带bias输入的接口配置该参数无效，会根据bias输入的位置来判断C矩阵初始值是否来源于CO1还是C2。</p>
</td>
</tr>
<tr id="row5802135801612"><td class="cellrowborder" valign="top" width="15.310000000000002%" headers="mcps1.2.3.1.1 "><p id="p730693132215"><a name="p730693132215"></a><a name="p730693132215"></a>isBias</p>
</td>
<td class="cellrowborder" valign="top" width="84.69%" headers="mcps1.2.3.1.2 "><p id="p18139740111713"><a name="p18139740111713"></a><a name="p18139740111713"></a><strong id="b1466113595178"><a name="b1466113595178"></a><a name="b1466113595178"></a>该参数废弃，新开发内容不要使用该参数。</strong>如果需要累加初始矩阵，请使用带bias的接口来实现；也可以通过cmatrixInitVal和cmatrixSource参数配置C矩阵的初始值来源来实现。推荐使用带bias的接口，相比于配置cmatrixInitVal和cmatrixSource参数更加简单方便。</p>
<p id="p15674612263"><a name="p15674612263"></a><a name="p15674612263"></a>配置是否需要累加初始矩阵，默认值为false，取值说明如下：</p>
<a name="ul1530653162214"></a><a name="ul1530653162214"></a><ul id="ul1530653162214"><li>false：矩阵乘，无需累加初始矩阵，C = A * B。</li><li>true：矩阵乘加，需要累加初始矩阵，C += A * B。</li></ul>
</td>
</tr>
<tr id="row55001333313"><td class="cellrowborder" valign="top" width="15.310000000000002%" headers="mcps1.2.3.1.1 "><p id="p115000313310"><a name="p115000313310"></a><a name="p115000313310"></a><span id="ph1287098193117"><a name="ph1287098193117"></a><a name="ph1287098193117"></a>unitFlag</span></p>
</td>
<td class="cellrowborder" valign="top" width="84.69%" headers="mcps1.2.3.1.2 "><p id="p103614380020"><a name="p103614380020"></a><a name="p103614380020"></a>unitFlag是一种Mmad指令和Fixpipe指令细粒度的并行，使能该功能后，硬件每计算完一个分形，计算结果就会被搬出，该功能不适用于在L0C Buffer累加的场景。取值说明如下：</p>
<p id="p1225131744220"><a name="p1225131744220"></a><a name="p1225131744220"></a>0：保留值；</p>
<p id="p3836113514213"><a name="p3836113514213"></a><a name="p3836113514213"></a>2：使能unitFlag，硬件执行完指令之后，不会关闭unitFlag功能；</p>
<p id="p173663815011"><a name="p173663815011"></a><a name="p173663815011"></a>3：使能unitFlag，硬件执行完指令之后，会将unitFlag功能关闭。</p>
<p id="p14988589213"><a name="p14988589213"></a><a name="p14988589213"></a>使能该功能时，Mmad指令的unitFlag在最后1个分形设置为3、其余分形计算设置为2即可。</p>
<p id="p181158034917"><a name="p181158034917"></a><a name="p181158034917"></a>该参数仅支持如下型号</p>
<p id="p15910825145415"><a name="p15910825145415"></a><a name="p15910825145415"></a><span id="ph1292674871116"><a name="ph1292674871116"></a><a name="ph1292674871116"></a><term id="zh-cn_topic_0000001312391781_term11962195213215_2"><a name="zh-cn_topic_0000001312391781_term11962195213215_2"></a><a name="zh-cn_topic_0000001312391781_term11962195213215_2"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term184716139811_2"><a name="zh-cn_topic_0000001312391781_term184716139811_2"></a><a name="zh-cn_topic_0000001312391781_term184716139811_2"></a>Atlas A2 推理系列产品</term></span></p>
<p id="p29873508148"><a name="p29873508148"></a><a name="p29873508148"></a><span id="ph13754548217"><a name="ph13754548217"></a><a name="ph13754548217"></a><term id="zh-cn_topic_0000001312391781_term1253731311225_2"><a name="zh-cn_topic_0000001312391781_term1253731311225_2"></a><a name="zh-cn_topic_0000001312391781_term1253731311225_2"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term131434243115_2"><a name="zh-cn_topic_0000001312391781_term131434243115_2"></a><a name="zh-cn_topic_0000001312391781_term131434243115_2"></a>Atlas A3 推理系列产品</term></span></p>
</td>
</tr>
<tr id="row429212884719"><td class="cellrowborder" valign="top" width="15.310000000000002%" headers="mcps1.2.3.1.1 "><p id="p92641454114714"><a name="p92641454114714"></a><a name="p92641454114714"></a>fmOffset</p>
</td>
<td class="cellrowborder" rowspan="5" valign="top" width="84.69%" headers="mcps1.2.3.1.2 "><p id="p6264205416479"><a name="p6264205416479"></a><a name="p6264205416479"></a>预留参数。为后续的功能做保留，开发者暂时无需关注，使用默认值即可。</p>
</td>
</tr>
<tr id="row209292371475"><td class="cellrowborder" valign="top" headers="mcps1.2.3.1.1 "><p id="p12264175418478"><a name="p12264175418478"></a><a name="p12264175418478"></a>enSsparse</p>
</td>
</tr>
<tr id="row48391634204717"><td class="cellrowborder" valign="top" headers="mcps1.2.3.1.1 "><p id="p6265145474711"><a name="p6265145474711"></a><a name="p6265145474711"></a>enWinogradA</p>
</td>
</tr>
<tr id="row2694932114712"><td class="cellrowborder" valign="top" headers="mcps1.2.3.1.1 "><p id="p152651254104718"><a name="p152651254104718"></a><a name="p152651254104718"></a>enWinogradB</p>
</td>
</tr>
<tr id="row1916264744713"><td class="cellrowborder" valign="top" headers="mcps1.2.3.1.1 "><p id="p926555412477"><a name="p926555412477"></a><a name="p926555412477"></a>kDirectionAlign</p>
</td>
</tr>
</tbody>
</table>

**表 4**  dst、fm、filter支持的精度类型组合（Atlas A2 训练系列产品/Atlas A2 推理系列产品）（Atlas A3 训练系列产品/Atlas A3 推理系列产品）

<a name="table311391475117"></a>
<table><thead align="left"><tr id="row1411401414517"><th class="cellrowborder" valign="top" width="33.306669333066694%" id="mcps1.2.4.1.1"><p id="p811451465120"><a name="p811451465120"></a><a name="p811451465120"></a><strong id="b911411143514"><a name="b911411143514"></a><a name="b911411143514"></a>左矩阵fm type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="33.38666133386661%" id="mcps1.2.4.1.2"><p id="p12114131425114"><a name="p12114131425114"></a><a name="p12114131425114"></a><strong id="b181141814135111"><a name="b181141814135111"></a><a name="b181141814135111"></a>右矩阵filter type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="33.306669333066694%" id="mcps1.2.4.1.3"><p id="p1911416143515"><a name="p1911416143515"></a><a name="p1911416143515"></a><strong id="b311491465115"><a name="b311491465115"></a><a name="b311491465115"></a>结果矩阵dst type</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="row161149142516"><td class="cellrowborder" valign="top" width="33.306669333066694%" headers="mcps1.2.4.1.1 "><p id="p11146148511"><a name="p11146148511"></a><a name="p11146148511"></a>int8_t</p>
</td>
<td class="cellrowborder" valign="top" width="33.38666133386661%" headers="mcps1.2.4.1.2 "><p id="p811412140514"><a name="p811412140514"></a><a name="p811412140514"></a>int8_t</p>
</td>
<td class="cellrowborder" valign="top" width="33.306669333066694%" headers="mcps1.2.4.1.3 "><p id="p3115151415515"><a name="p3115151415515"></a><a name="p3115151415515"></a>int32_t</p>
</td>
</tr>
<tr id="row1511610143518"><td class="cellrowborder" valign="top" width="33.306669333066694%" headers="mcps1.2.4.1.1 "><p id="p1411641405115"><a name="p1411641405115"></a><a name="p1411641405115"></a>half</p>
</td>
<td class="cellrowborder" valign="top" width="33.38666133386661%" headers="mcps1.2.4.1.2 "><p id="p011611145512"><a name="p011611145512"></a><a name="p011611145512"></a>half</p>
</td>
<td class="cellrowborder" valign="top" width="33.306669333066694%" headers="mcps1.2.4.1.3 "><p id="p3116214165119"><a name="p3116214165119"></a><a name="p3116214165119"></a>float</p>
</td>
</tr>
<tr id="row1211613149517"><td class="cellrowborder" valign="top" width="33.306669333066694%" headers="mcps1.2.4.1.1 "><p id="p01161014125111"><a name="p01161014125111"></a><a name="p01161014125111"></a>float</p>
</td>
<td class="cellrowborder" valign="top" width="33.38666133386661%" headers="mcps1.2.4.1.2 "><p id="p19116191465116"><a name="p19116191465116"></a><a name="p19116191465116"></a>float</p>
</td>
<td class="cellrowborder" valign="top" width="33.306669333066694%" headers="mcps1.2.4.1.3 "><p id="p8116131465115"><a name="p8116131465115"></a><a name="p8116131465115"></a>float</p>
</td>
</tr>
<tr id="row114323324291"><td class="cellrowborder" valign="top" width="33.306669333066694%" headers="mcps1.2.4.1.1 "><p id="p19432132192918"><a name="p19432132192918"></a><a name="p19432132192918"></a>bfloat16_t</p>
</td>
<td class="cellrowborder" valign="top" width="33.38666133386661%" headers="mcps1.2.4.1.2 "><p id="p9432163219291"><a name="p9432163219291"></a><a name="p9432163219291"></a>bfloat16_t</p>
</td>
<td class="cellrowborder" valign="top" width="33.306669333066694%" headers="mcps1.2.4.1.3 "><p id="p44321132112912"><a name="p44321132112912"></a><a name="p44321132112912"></a>float</p>
</td>
</tr>
<tr id="row1276714822814"><td class="cellrowborder" valign="top" width="33.306669333066694%" headers="mcps1.2.4.1.1 "><p id="p11767144892815"><a name="p11767144892815"></a><a name="p11767144892815"></a>int4b_t</p>
</td>
<td class="cellrowborder" valign="top" width="33.38666133386661%" headers="mcps1.2.4.1.2 "><p id="p1876764818287"><a name="p1876764818287"></a><a name="p1876764818287"></a>int4b_t</p>
</td>
<td class="cellrowborder" valign="top" width="33.306669333066694%" headers="mcps1.2.4.1.3 "><p id="p12767204814282"><a name="p12767204814282"></a><a name="p12767204814282"></a>int32_t</p>
</td>
</tr>
</tbody>
</table>

**表 5**  dst、fm、filter、bias支持的精度类型组合（Atlas A2 训练系列产品/Atlas A2 推理系列产品）（Atlas A3 训练系列产品/Atlas A3 推理系列产品）

<a name="table1068062217226"></a>
<table><thead align="left"><tr id="row14680182202213"><th class="cellrowborder" valign="top" width="23.1%" id="mcps1.2.5.1.1"><p id="p1680192219225"><a name="p1680192219225"></a><a name="p1680192219225"></a><strong id="b126801322112219"><a name="b126801322112219"></a><a name="b126801322112219"></a>左矩阵fm type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="23.71%" id="mcps1.2.5.1.2"><p id="p11680222102214"><a name="p11680222102214"></a><a name="p11680222102214"></a><strong id="b168082214228"><a name="b168082214228"></a><a name="b168082214228"></a>右矩阵filter type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="22.39%" id="mcps1.2.5.1.3"><p id="p16618105212225"><a name="p16618105212225"></a><a name="p16618105212225"></a><strong id="b671210581220"><a name="b671210581220"></a><a name="b671210581220"></a>bias type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="30.8%" id="mcps1.2.5.1.4"><p id="p17680162220223"><a name="p17680162220223"></a><a name="p17680162220223"></a><strong id="b8680122213229"><a name="b8680122213229"></a><a name="b8680122213229"></a>结果矩阵dst type</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="row1668111225223"><td class="cellrowborder" valign="top" width="23.1%" headers="mcps1.2.5.1.1 "><p id="p206812223227"><a name="p206812223227"></a><a name="p206812223227"></a>int8_t</p>
</td>
<td class="cellrowborder" valign="top" width="23.71%" headers="mcps1.2.5.1.2 "><p id="p186816226224"><a name="p186816226224"></a><a name="p186816226224"></a>int8_t</p>
</td>
<td class="cellrowborder" valign="top" width="22.39%" headers="mcps1.2.5.1.3 "><p id="p555512397238"><a name="p555512397238"></a><a name="p555512397238"></a>int32_t</p>
</td>
<td class="cellrowborder" valign="top" width="30.8%" headers="mcps1.2.5.1.4 "><p id="p2681152210220"><a name="p2681152210220"></a><a name="p2681152210220"></a>int32_t</p>
</td>
</tr>
<tr id="row16681822102220"><td class="cellrowborder" valign="top" width="23.1%" headers="mcps1.2.5.1.1 "><p id="p1968110226225"><a name="p1968110226225"></a><a name="p1968110226225"></a>half</p>
</td>
<td class="cellrowborder" valign="top" width="23.71%" headers="mcps1.2.5.1.2 "><p id="p1681222132215"><a name="p1681222132215"></a><a name="p1681222132215"></a>half</p>
</td>
<td class="cellrowborder" valign="top" width="22.39%" headers="mcps1.2.5.1.3 "><p id="p166181252182216"><a name="p166181252182216"></a><a name="p166181252182216"></a>float</p>
</td>
<td class="cellrowborder" valign="top" width="30.8%" headers="mcps1.2.5.1.4 "><p id="p1668162262218"><a name="p1668162262218"></a><a name="p1668162262218"></a>float</p>
</td>
</tr>
<tr id="row1968118229223"><td class="cellrowborder" valign="top" width="23.1%" headers="mcps1.2.5.1.1 "><p id="p7681132222215"><a name="p7681132222215"></a><a name="p7681132222215"></a>float</p>
</td>
<td class="cellrowborder" valign="top" width="23.71%" headers="mcps1.2.5.1.2 "><p id="p1068110224220"><a name="p1068110224220"></a><a name="p1068110224220"></a>float</p>
</td>
<td class="cellrowborder" valign="top" width="22.39%" headers="mcps1.2.5.1.3 "><p id="p137414812312"><a name="p137414812312"></a><a name="p137414812312"></a>float</p>
</td>
<td class="cellrowborder" valign="top" width="30.8%" headers="mcps1.2.5.1.4 "><p id="p568142215220"><a name="p568142215220"></a><a name="p568142215220"></a>float</p>
</td>
</tr>
<tr id="row19681202252213"><td class="cellrowborder" valign="top" width="23.1%" headers="mcps1.2.5.1.1 "><p id="p368192212219"><a name="p368192212219"></a><a name="p368192212219"></a>bfloat16_t</p>
</td>
<td class="cellrowborder" valign="top" width="23.71%" headers="mcps1.2.5.1.2 "><p id="p488214213466"><a name="p488214213466"></a><a name="p488214213466"></a>bfloat16_t</p>
</td>
<td class="cellrowborder" valign="top" width="22.39%" headers="mcps1.2.5.1.3 "><p id="p11929548172310"><a name="p11929548172310"></a><a name="p11929548172310"></a>float</p>
</td>
<td class="cellrowborder" valign="top" width="30.8%" headers="mcps1.2.5.1.4 "><p id="p136811522122220"><a name="p136811522122220"></a><a name="p136811522122220"></a>float</p>
</td>
</tr>
</tbody>
</table>

**表 6**  dst、fm、filter、bias支持的精度类型组合 （Kirin 9030）

<a name="table1967917541518"></a>
<table><thead align="left"><tr id="row10680654195111"><th class="cellrowborder" valign="top" width="23.1%" id="mcps1.2.5.1.1"><p id="p19680105405113"><a name="p19680105405113"></a><a name="p19680105405113"></a><strong id="b768065485115"><a name="b768065485115"></a><a name="b768065485115"></a>左矩阵fm type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="23.71%" id="mcps1.2.5.1.2"><p id="p1168065475117"><a name="p1168065475117"></a><a name="p1168065475117"></a><strong id="b12680854195114"><a name="b12680854195114"></a><a name="b12680854195114"></a>右矩阵filter type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="22.39%" id="mcps1.2.5.1.3"><p id="p14681185405118"><a name="p14681185405118"></a><a name="p14681185405118"></a><strong id="b1768165485118"><a name="b1768165485118"></a><a name="b1768165485118"></a>bias type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="30.8%" id="mcps1.2.5.1.4"><p id="p1368111548511"><a name="p1368111548511"></a><a name="p1368111548511"></a><strong id="b166811854135111"><a name="b166811854135111"></a><a name="b166811854135111"></a>结果矩阵dst type</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="row12681165411518"><td class="cellrowborder" valign="top" width="23.1%" headers="mcps1.2.5.1.1 "><p id="p14681155419516"><a name="p14681155419516"></a><a name="p14681155419516"></a>half</p>
</td>
<td class="cellrowborder" valign="top" width="23.71%" headers="mcps1.2.5.1.2 "><p id="p106811754125110"><a name="p106811754125110"></a><a name="p106811754125110"></a>half</p>
</td>
<td class="cellrowborder" valign="top" width="22.39%" headers="mcps1.2.5.1.3 "><p id="p10681754105118"><a name="p10681754105118"></a><a name="p10681754105118"></a>half</p>
</td>
<td class="cellrowborder" valign="top" width="30.8%" headers="mcps1.2.5.1.4 "><p id="p1368135416513"><a name="p1368135416513"></a><a name="p1368135416513"></a>half</p>
</td>
</tr>
</tbody>
</table>

**表 7**  dst、fm、filter、bias支持的精度类型组合 （Kirin x90）

<a name="table128881130185314"></a>
<table><thead align="left"><tr id="row68884308538"><th class="cellrowborder" valign="top" width="23.1%" id="mcps1.2.5.1.1"><p id="p1888863016536"><a name="p1888863016536"></a><a name="p1888863016536"></a><strong id="b58886308539"><a name="b58886308539"></a><a name="b58886308539"></a>左矩阵fm type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="23.71%" id="mcps1.2.5.1.2"><p id="p9889163075311"><a name="p9889163075311"></a><a name="p9889163075311"></a><strong id="b1988923011539"><a name="b1988923011539"></a><a name="b1988923011539"></a>右矩阵filter type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="22.39%" id="mcps1.2.5.1.3"><p id="p1388923017532"><a name="p1388923017532"></a><a name="p1388923017532"></a><strong id="b68897309535"><a name="b68897309535"></a><a name="b68897309535"></a>bias type</strong></p>
</th>
<th class="cellrowborder" valign="top" width="30.8%" id="mcps1.2.5.1.4"><p id="p3889103018538"><a name="p3889103018538"></a><a name="p3889103018538"></a><strong id="b3889930175315"><a name="b3889930175315"></a><a name="b3889930175315"></a>结果矩阵dst type</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="row1088903010531"><td class="cellrowborder" valign="top" width="23.1%" headers="mcps1.2.5.1.1 "><p id="p1989093012538"><a name="p1989093012538"></a><a name="p1989093012538"></a>int8_t</p>
</td>
<td class="cellrowborder" valign="top" width="23.71%" headers="mcps1.2.5.1.2 "><p id="p6890330115311"><a name="p6890330115311"></a><a name="p6890330115311"></a>int8_t</p>
</td>
<td class="cellrowborder" valign="top" width="22.39%" headers="mcps1.2.5.1.3 "><p id="p20890123025312"><a name="p20890123025312"></a><a name="p20890123025312"></a>int32_t</p>
</td>
<td class="cellrowborder" valign="top" width="30.8%" headers="mcps1.2.5.1.4 "><p id="p1989193035314"><a name="p1989193035314"></a><a name="p1989193035314"></a>int32_t</p>
</td>
</tr>
<tr id="row48911630195318"><td class="cellrowborder" valign="top" width="23.1%" headers="mcps1.2.5.1.1 "><p id="p78915306532"><a name="p78915306532"></a><a name="p78915306532"></a>half</p>
</td>
<td class="cellrowborder" valign="top" width="23.71%" headers="mcps1.2.5.1.2 "><p id="p1589123035317"><a name="p1589123035317"></a><a name="p1589123035317"></a>half</p>
</td>
<td class="cellrowborder" valign="top" width="22.39%" headers="mcps1.2.5.1.3 "><p id="p1689123012532"><a name="p1689123012532"></a><a name="p1689123012532"></a>half</p>
</td>
<td class="cellrowborder" valign="top" width="30.8%" headers="mcps1.2.5.1.4 "><p id="p158911730145319"><a name="p158911730145319"></a><a name="p158911730145319"></a>half</p>
</td>
</tr>
</tbody>
</table>

## 约束说明<a name="section633mcpsimp"></a>

-   dst只支持位于CO1，fm只支持位于A2，filter只支持位于B2。
-   当M、K、N中的任意一个值为0时，该指令不会被执行。
-   当M = 1时，会默认开启GEMV（General Matrix-Vector Multiplication）功能。在这种情况下，Mmad API从L0A Buffer读取数据时，会以ND格式进行读取，而不会将其视为ZZ格式。所以此时左矩阵需要直接按照ND格式进行排布。
-   操作数地址对齐要求请参见[通用地址对齐约束](通用说明和约束.md#section796754519912)。
-   通过一个具体的示例来介绍无效数据与有效数据的排布方式。

    数据为half类型，当M=30，K=70，N=40的时候，A2中有2x5个16x16矩阵，B2中有5x3个16x16矩阵，CO1中有2x3个16x16矩阵。在这种场景下M、K和N都不是16的倍数，A2中右下角的矩阵实际有效的数据只有14x6个，但是也需要占一个16x16矩阵的空间，其他无效数据在计算中会被忽略。一个16x16分形的数据块中，无效数据与有效数据排布的方式示意如下：

    ![](figures/repeat-times-17.png)

## 调用示例<a name="section642mcpsimp"></a>

不含矩阵乘偏置的样例请参考[Mmad样例](https://gitee.com/ascend/samples/tree/master/operator/ascendc/0_introduction/20_mmad_kernellaunch/MmadInvocation)。

包含矩阵乘偏置的样例请参考[包含矩阵乘偏置的Mmad样例](https://gitee.com/ascend/samples/blob/master/operator/ascendc/0_introduction/20_mmad_kernellaunch/MmadBiasInvocation/)。

