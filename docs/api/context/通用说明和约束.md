# 通用说明和约束<a name="ZH-CN_TOPIC_0000001714258422"></a>

## 需要包含的头文件<a name="section1299152225418"></a>

>![](public_sys-resources/icon-note.gif) **说明：** 
>Ascend C API所在头文件目录为：
>-   基础API：$\{INSTALL\_DIR\}/include/ascendc/basic\_api/interface
>-   高阶API：（注意，如下目录头文件中包含的接口如果未在资料中声明，属于间接调用接口，开发者无需关注）
>    -   $\{INSTALL\_DIR\}/include/ascendc/highlevel\_api/lib
>    -   $\{INSTALL\_DIR\}/include/tiling
>$\{INSTALL\_DIR\}请替换为CANN软件安装后文件存储路径。若安装的Ascend-cann-toolkit软件包，以root安装举例，则安装后文件存储路径为：/usr/local/Ascend/latest。

为方便开发者使用，Ascend C基础API和高阶API均支持通过包含kernel\_operator.h文件来调用相应接口。如无特殊说明，包含该头文件即可满足接口调用需求。若API文档中有特殊说明，则应遵循API的具体说明。

```
#include "kernel_operator.h"
```

## 逻辑位置和物理存储的映射关系<a name="section1359919519819"></a>

Ascend C API的操作数通常为[GlobalTensor](GlobalTensor.md)和[LocalTensor](LocalTensor.md)，Tensor数据的存储位置均使用逻辑位置（[TPosition](TPosition.md)）来表达，从而隐藏了硬件架构的差异。TPosition类型包括：VECIN、VECOUT、VECCALC、A1、A2、B1、B2、CO1、CO2等，其与物理内存的映射关系如下表所示。

**表 1**  TPosition与物理内存映射关系

<a name="table07372185712"></a>
<table><thead align="left"><tr id="row14737131145714"><th class="cellrowborder" valign="top" width="50%" id="mcps1.2.3.1.1"><p id="p1873820117575"><a name="p1873820117575"></a><a name="p1873820117575"></a>TPosition</p>
</th>
<th class="cellrowborder" valign="top" width="50%" id="mcps1.2.3.1.2"><p id="p17738114577"><a name="p17738114577"></a><a name="p17738114577"></a>物理内存</p>
</th>
</tr>
</thead>
<tbody><tr id="row1673812116578"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p173881165710"><a name="p173881165710"></a><a name="p173881165710"></a>GM</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p6297557165816"><a name="p6297557165816"></a><a name="p6297557165816"></a><span id="ph8297165725819"><a name="ph8297165725819"></a><a name="ph8297165725819"></a>Global Memory</span></p>
</td>
</tr>
<tr id="row121092184581"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p12110141816581"><a name="p12110141816581"></a><a name="p12110141816581"></a>VECIN</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p3882843155817"><a name="p3882843155817"></a><a name="p3882843155817"></a><span id="ph1088254310583"><a name="ph1088254310583"></a><a name="ph1088254310583"></a>Unified Buffer</span></p>
</td>
</tr>
<tr id="row1896492323612"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p53381333163615"><a name="p53381333163615"></a><a name="p53381333163615"></a>VECCALC</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p7961153619363"><a name="p7961153619363"></a><a name="p7961153619363"></a><span id="ph1696163623613"><a name="ph1696163623613"></a><a name="ph1696163623613"></a>Unified Buffer</span></p>
</td>
</tr>
<tr id="row6115182085817"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p1411511200587"><a name="p1411511200587"></a><a name="p1411511200587"></a>VECOUT</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p12115020155818"><a name="p12115020155818"></a><a name="p12115020155818"></a><span id="ph7713844125812"><a name="ph7713844125812"></a><a name="ph7713844125812"></a>Unified Buffer</span></p>
</td>
</tr>
<tr id="row2738161205712"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p17738191205714"><a name="p17738191205714"></a><a name="p17738191205714"></a>A1</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p73556221719"><a name="p73556221719"></a><a name="p73556221719"></a><span id="ph1535518221316"><a name="ph1535518221316"></a><a name="ph1535518221316"></a>L1 Buffer</span></p>
</td>
</tr>
<tr id="row573816110577"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p107388125719"><a name="p107388125719"></a><a name="p107388125719"></a>A2</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p177501916523"><a name="p177501916523"></a><a name="p177501916523"></a><span id="ph167502169211"><a name="ph167502169211"></a><a name="ph167502169211"></a>L0A Buffer</span></p>
</td>
</tr>
<tr id="row77382125716"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p27381415579"><a name="p27381415579"></a><a name="p27381415579"></a>B1</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p3773322817"><a name="p3773322817"></a><a name="p3773322817"></a><span id="ph677317221216"><a name="ph677317221216"></a><a name="ph677317221216"></a>L1 Buffer</span></p>
</td>
</tr>
<tr id="row57381618577"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p273841125711"><a name="p273841125711"></a><a name="p273841125711"></a>B2</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p18433419327"><a name="p18433419327"></a><a name="p18433419327"></a><span id="ph44331191521"><a name="ph44331191521"></a><a name="ph44331191521"></a>L0B Buffer</span></p>
</td>
</tr>
<tr id="row1873813117577"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p973811112575"><a name="p973811112575"></a><a name="p973811112575"></a>C1</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p154731031172111"><a name="p154731031172111"></a><a name="p154731031172111"></a><span id="ph18473113172113"><a name="ph18473113172113"></a><a name="ph18473113172113"></a><term id="zh-cn_topic_0000001312391781_term11962195213215"><a name="zh-cn_topic_0000001312391781_term11962195213215"></a><a name="zh-cn_topic_0000001312391781_term11962195213215"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term1551319498507"><a name="zh-cn_topic_0000001312391781_term1551319498507"></a><a name="zh-cn_topic_0000001312391781_term1551319498507"></a>Atlas A2 推理系列产品</term></span>，<span id="ph540018302214"><a name="ph540018302214"></a><a name="ph540018302214"></a>L1 Buffer</span>。</p>
<p id="p29873508148"><a name="p29873508148"></a><a name="p29873508148"></a><span id="ph13754548217"><a name="ph13754548217"></a><a name="ph13754548217"></a><term id="zh-cn_topic_0000001312391781_term1253731311225"><a name="zh-cn_topic_0000001312391781_term1253731311225"></a><a name="zh-cn_topic_0000001312391781_term1253731311225"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term12835255145414"><a name="zh-cn_topic_0000001312391781_term12835255145414"></a><a name="zh-cn_topic_0000001312391781_term12835255145414"></a>Atlas A3 推理系列产品</term></span>，<span id="ph1913263134216"><a name="ph1913263134216"></a><a name="ph1913263134216"></a>L1 Buffer</span>。</p>
</td>
</tr>
<tr id="row177386155718"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p177381019571"><a name="p177381019571"></a><a name="p177381019571"></a>C2</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p3618344102219"><a name="p3618344102219"></a><a name="p3618344102219"></a><span id="ph146188444223"><a name="ph146188444223"></a><a name="ph146188444223"></a><term id="zh-cn_topic_0000001312391781_term11962195213215_1"><a name="zh-cn_topic_0000001312391781_term11962195213215_1"></a><a name="zh-cn_topic_0000001312391781_term11962195213215_1"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term1551319498507_1"><a name="zh-cn_topic_0000001312391781_term1551319498507_1"></a><a name="zh-cn_topic_0000001312391781_term1551319498507_1"></a>Atlas A2 推理系列产品</term></span>，BiasTable Buffer。</p>
<p id="p14398161615423"><a name="p14398161615423"></a><a name="p14398161615423"></a><span id="ph18398181624219"><a name="ph18398181624219"></a><a name="ph18398181624219"></a><term id="zh-cn_topic_0000001312391781_term1253731311225_1"><a name="zh-cn_topic_0000001312391781_term1253731311225_1"></a><a name="zh-cn_topic_0000001312391781_term1253731311225_1"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term12835255145414_1"><a name="zh-cn_topic_0000001312391781_term12835255145414_1"></a><a name="zh-cn_topic_0000001312391781_term12835255145414_1"></a>Atlas A3 推理系列产品</term></span>，BiasTable Buffer。</p>
</td>
</tr>
<tr id="row13282184315597"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p5283154314595"><a name="p5283154314595"></a><a name="p5283154314595"></a>CO1</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p913118216218"><a name="p913118216218"></a><a name="p913118216218"></a><span id="ph113142825"><a name="ph113142825"></a><a name="ph113142825"></a>L0C Buffer</span></p>
</td>
</tr>
<tr id="row152804915592"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p3528194995919"><a name="p3528194995919"></a><a name="p3528194995919"></a>CO2</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p19491195142513"><a name="p19491195142513"></a><a name="p19491195142513"></a><span id="ph949110518256"><a name="ph949110518256"></a><a name="ph949110518256"></a><term id="zh-cn_topic_0000001312391781_term11962195213215_2"><a name="zh-cn_topic_0000001312391781_term11962195213215_2"></a><a name="zh-cn_topic_0000001312391781_term11962195213215_2"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term1551319498507_2"><a name="zh-cn_topic_0000001312391781_term1551319498507_2"></a><a name="zh-cn_topic_0000001312391781_term1551319498507_2"></a>Atlas A2 推理系列产品</term></span>，Global Memory。</p>
<p id="p978163810420"><a name="p978163810420"></a><a name="p978163810420"></a><span id="ph1678738184217"><a name="ph1678738184217"></a><a name="ph1678738184217"></a><term id="zh-cn_topic_0000001312391781_term1253731311225_2"><a name="zh-cn_topic_0000001312391781_term1253731311225_2"></a><a name="zh-cn_topic_0000001312391781_term1253731311225_2"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term12835255145414_2"><a name="zh-cn_topic_0000001312391781_term12835255145414_2"></a><a name="zh-cn_topic_0000001312391781_term12835255145414_2"></a>Atlas A3 推理系列产品</term></span>，Global Memory。</p>
</td>
</tr>
<tr id="row1320918216104"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p10209132111018"><a name="p10209132111018"></a><a name="p10209132111018"></a>TSCM</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p220962121013"><a name="p220962121013"></a><a name="p220962121013"></a><span id="ph9100102910103"><a name="ph9100102910103"></a><a name="ph9100102910103"></a>L1 Buffer</span></p>
</td>
</tr>
<tr id="row10174030113220"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p1517563073219"><a name="p1517563073219"></a><a name="p1517563073219"></a>SPM</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p175596813416"><a name="p175596813416"></a><a name="p175596813416"></a><span id="ph155592817417"><a name="ph155592817417"></a><a name="ph155592817417"></a><term id="zh-cn_topic_0000001312391781_term11962195213215_3"><a name="zh-cn_topic_0000001312391781_term11962195213215_3"></a><a name="zh-cn_topic_0000001312391781_term11962195213215_3"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term1551319498507_3"><a name="zh-cn_topic_0000001312391781_term1551319498507_3"></a><a name="zh-cn_topic_0000001312391781_term1551319498507_3"></a>Atlas A2 推理系列产品</term></span>，Global Memory。</p>
<p id="p9298631122210"><a name="p9298631122210"></a><a name="p9298631122210"></a><span id="ph17298153111224"><a name="ph17298153111224"></a><a name="ph17298153111224"></a><term id="zh-cn_topic_0000001312391781_term1253731311225_3"><a name="zh-cn_topic_0000001312391781_term1253731311225_3"></a><a name="zh-cn_topic_0000001312391781_term1253731311225_3"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term12835255145414_3"><a name="zh-cn_topic_0000001312391781_term12835255145414_3"></a><a name="zh-cn_topic_0000001312391781_term12835255145414_3"></a>Atlas A3 推理系列产品</term></span>，Global Memory。</p>
</td>
</tr>
<tr id="row58791634172316"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="p1588033412316"><a name="p1588033412316"></a><a name="p1588033412316"></a>C2PIPE2GM</p>
</td>
<td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="p69257313278"><a name="p69257313278"></a><a name="p69257313278"></a><span id="ph1380244822614"><a name="ph1380244822614"></a><a name="ph1380244822614"></a><term id="zh-cn_topic_0000001312391781_term11962195213215_4"><a name="zh-cn_topic_0000001312391781_term11962195213215_4"></a><a name="zh-cn_topic_0000001312391781_term11962195213215_4"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term1551319498507_4"><a name="zh-cn_topic_0000001312391781_term1551319498507_4"></a><a name="zh-cn_topic_0000001312391781_term1551319498507_4"></a>Atlas A2 推理系列产品</term></span>，<span>Fixpipe</span><span> Buffer</span>。</p>
<p id="p1067558112613"><a name="p1067558112613"></a><a name="p1067558112613"></a><span id="ph1680215483262"><a name="ph1680215483262"></a><a name="ph1680215483262"></a><term id="zh-cn_topic_0000001312391781_term1253731311225_4"><a name="zh-cn_topic_0000001312391781_term1253731311225_4"></a><a name="zh-cn_topic_0000001312391781_term1253731311225_4"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000001312391781_term12835255145414_4"><a name="zh-cn_topic_0000001312391781_term12835255145414_4"></a><a name="zh-cn_topic_0000001312391781_term12835255145414_4"></a>Atlas A3 推理系列产品</term></span>，<span>Fixpipe</span><span> Buffer</span>。</p>
</td>
</tr>
</tbody>
</table>

## 通用地址对齐约束<a name="section796754519912"></a>

AI Core上的存储单元用于存储矢量计算、矩阵计算的源操作数和目的操作数，各类存储单元的对齐要求如[表2](#table16278354141117)所示，因此Ascend C API操作数的起始地址对齐要求应与这些存储单元的对齐要求保持一致。**需要注意的是，如果接口中已明确说明操作数起始地址对齐要求，则以具体API中的说明为准。**

**表 2**  不同存储单元的对齐要求

<a name="table16278354141117"></a>
<table><thead align="left"><tr id="row1827835418116"><th class="cellrowborder" valign="top" width="24.15%" id="mcps1.2.3.1.1"><p id="p1927845481114"><a name="p1927845481114"></a><a name="p1927845481114"></a>存储单元</p>
</th>
<th class="cellrowborder" valign="top" width="75.85%" id="mcps1.2.3.1.2"><p id="p15278165413113"><a name="p15278165413113"></a><a name="p15278165413113"></a>对齐要求</p>
</th>
</tr>
</thead>
<tbody><tr id="row5989518428"><td class="cellrowborder" valign="top" width="24.15%" headers="mcps1.2.3.1.1 "><p id="p12786547114"><a name="p12786547114"></a><a name="p12786547114"></a><span id="ph64037249135"><a name="ph64037249135"></a><a name="ph64037249135"></a>Global Memory</span></p>
</td>
<td class="cellrowborder" valign="top" width="75.85%" headers="mcps1.2.3.1.2 "><p id="p112781554101116"><a name="p112781554101116"></a><a name="p112781554101116"></a>无对齐要求。</p>
</td>
</tr>
<tr id="row1427810549118"><td class="cellrowborder" valign="top" width="24.15%" headers="mcps1.2.3.1.1 "><p id="p152784546112"><a name="p152784546112"></a><a name="p152784546112"></a><span id="ph0136142113115"><a name="ph0136142113115"></a><a name="ph0136142113115"></a>Unified Buffer</span></p>
</td>
<td class="cellrowborder" valign="top" width="75.85%" headers="mcps1.2.3.1.2 "><p id="p104523511813"><a name="p104523511813"></a><a name="p104523511813"></a>32Byte对齐。</p>
</td>
</tr>
<tr id="row15278135441120"><td class="cellrowborder" valign="top" width="24.15%" headers="mcps1.2.3.1.1 "><p id="p14278954181110"><a name="p14278954181110"></a><a name="p14278954181110"></a><span id="ph188413550332"><a name="ph188413550332"></a><a name="ph188413550332"></a>L1 Buffer</span></p>
</td>
<td class="cellrowborder" valign="top" width="75.85%" headers="mcps1.2.3.1.2 "><p id="p827895431116"><a name="p827895431116"></a><a name="p827895431116"></a>32Byte对齐。</p>
</td>
</tr>
<tr id="row1911115484402"><td class="cellrowborder" valign="top" width="24.15%" headers="mcps1.2.3.1.1 "><p id="p12111548144020"><a name="p12111548144020"></a><a name="p12111548144020"></a><span id="ph15972183811415"><a name="ph15972183811415"></a><a name="ph15972183811415"></a>L0A Buffer</span>/<span id="ph1758314126434"><a name="ph1758314126434"></a><a name="ph1758314126434"></a>L0B Buffer</span></p>
</td>
<td class="cellrowborder" valign="top" width="75.85%" headers="mcps1.2.3.1.2 "><p id="p1411164812407"><a name="p1411164812407"></a><a name="p1411164812407"></a>512Byte对齐。</p>
</td>
</tr>
<tr id="row7837101412434"><td class="cellrowborder" valign="top" width="24.15%" headers="mcps1.2.3.1.1 "><p id="p158371714124319"><a name="p158371714124319"></a><a name="p158371714124319"></a><span id="ph17632034174314"><a name="ph17632034174314"></a><a name="ph17632034174314"></a>L0C Buffer</span></p>
</td>
<td class="cellrowborder" valign="top" width="75.85%" headers="mcps1.2.3.1.2 "><p id="p583791419438"><a name="p583791419438"></a><a name="p583791419438"></a>64Byte对齐。</p>
</td>
</tr>
<tr id="row1759019914415"><td class="cellrowborder" valign="top" width="24.15%" headers="mcps1.2.3.1.1 "><p id="p146691215377"><a name="p146691215377"></a><a name="p146691215377"></a>BiasTable Buffer</p>
</td>
<td class="cellrowborder" valign="top" width="75.85%" headers="mcps1.2.3.1.2 "><p id="p18153830104420"><a name="p18153830104420"></a><a name="p18153830104420"></a>64Byte对齐。</p>
</td>
</tr>
<tr id="row17330332204417"><td class="cellrowborder" valign="top" width="24.15%" headers="mcps1.2.3.1.1 "><p id="p3330133212440"><a name="p3330133212440"></a><a name="p3330133212440"></a><span>Fixpipe</span><span> Buffer</span></p>
</td>
<td class="cellrowborder" valign="top" width="75.85%" headers="mcps1.2.3.1.2 "><p id="p13408435141710"><a name="p13408435141710"></a><a name="p13408435141710"></a>64Byte对齐。</p>
</td>
</tr>
</tbody>
</table>

## 通用地址重叠约束<a name="section668772811100"></a>

使用基础API的Tensor高维切分计算接口时，为了节省地址空间，开发者可以定义一个Tensor，供源操作数与目的操作数同时使用（即地址重叠）。使用时需要注意以下约束：

-   单次迭代内：源操作数与目的操作数必须100%完全重叠，不支持部分重叠。
-   多次迭代间：不支持前序迭代的目的操作数与后序迭代的源操作数重叠。例如，第N次迭代的目的操作数是第N+1次的源操作数（如下图所示）。在这种情况下，第N次迭代可能会改写覆盖源操作数的数值，导致无法得到预期结果。特别地，对于部分双目计算类的API（Add、Sub、Mul、Max、Min、AddRelu、SubRelu），当数据类型为half、int32\_t、float时，支持前序迭代的目的操作数与后序迭代的源操作数重叠：仅针对目的操作数和第二个源操作数重叠的情况，且src1RepStride或者dstRepStride必须为0。

**图 1**  地址重叠示例（不支持）<a name="fig12654416181216"></a>  
![](figures/地址重叠示例（不支持）.png "地址重叠示例（不支持）")

>![](public_sys-resources/icon-note.gif) **说明：** 
>本节所述地址重叠通用约束适用于一般情况，API参考中如有额外特殊说明的，则以具体API中的说明为准。
>API中没有描述地址重叠约束的，视为不支持Tensor高维切分计算的地址重叠，地址重叠时计算结果可能不满足预期。

